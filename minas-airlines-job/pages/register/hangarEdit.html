<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minas Airlines</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../register/registerStyle.css"/>
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
</head>
<body>
    <!-- Navbar -->
    <ul class="nav bg-info px-3 py-2">
        <li class="nav-item d-flex align-items-center">
            <img src="../../assets/img/logo.png" style="width: 180px; margin-top: 15px; margin-bottom: 15px; margin-left: 60px;" alt="Minha Imagem">
        </li>
        <li class="nav-item ms-auto">
            <a class="nav-link link-light" href="../all_airplane/airplanePage.html">Aeronaves</a>
        </li>
        <li class="nav-item">
            <a class="nav-link link-light" href="../hangar/hangarPage.html">Hangar</a>
        </li>
        <li class="nav-item d-flex align-items-center">
            <i class="bi bi-broadcast" style="color: rgb(230, 20, 20); margin-right: 5px;"></i>
            <a class="nav-link link-light" href="../monitoring/monitoringPage.html">Monitoramento</a>
        </li>
        <li class="nav-item d-flex align-items-center ms-3">
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center justify-content-center bg-light rounded-circle" style="width: 40px; height: 40px;" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person" style="font-size: 1.5rem; color: #1E234B;"></i>
                </a>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                    <li><a class="dropdown-item" href="../../index.html">Sair</a></li>
                </ul>
            </div>
        </li>
    </ul>

    <div class="main">
        <div class="nav-register d-flex align-items-center">
            <a href="../hangar/hangarPage.html" style="color: rgb(65, 65, 65);"><i class="bi bi-arrow-left" style="font-size: 35px; margin-right: 20px; cursor: pointer;"></i></a>
            <h1>Editar hangar</h1>
        </div>
        <form class="row g-3">
            <div class="col-md-6">
                <label for="codigo" class="form-label">Código</label>
                <input type="text" class="form-control" id="codigo" placeholder="Informe o cód.">
            </div>
            <div class="col-md-6">
                <label for="nome" class="form-label">Nome</label>
                <input type="text" class="form-control" id="nome" placeholder="Informe o nome do hangar">
            </div>
            <div class="col-md-6">
                <label for="tipo" class="form-label">Tipo</label>
                <select id="tipo" class="form-select"></select>
            </div>
            <div class="col-6">
                <label for="capacidade_maxima" class="form-label">Capacidade máxima</label>
                <input type="text" class="form-control" id="capacidade_maxima" placeholder="Informe o modelo">
            </div>
            <div class="col-6">
                <label for="localizacao" class="form-label">Localização</label>
                <input type="text" class="form-control" id="localizacao" placeholder="Informe a localização">
            </div>
            <div class="col-6">
                <label for="aeronaves" class="form-label">Aeronaves</label>
              
                <div class="d-flex align-items-center gap-2">
                    <select id="aeronaves-select" class="form-select">
                        <!-- Opcões de aeronaves disponíveis para adicionar -->
                    </select>
                    <button type="button" class="btn btn-primary" onclick="adicionarAeronave()">Adicionar</button>
                </div>
                <div id="aeronaves-container" class="d-flex flex-wrap gap-2 mb-3">
                    <!-- As aeronaves vinculadas ao hangar serão exibidas como tags aqui -->
                </div>
            </div>
            
            
        </form>
        <div class="d-flex justify-content-end mt-3">
            <button type="button" class="btn2 me-2" data-bs-toggle="modal" data-bs-target="#cancelModal">Cancelar</button>
            <button id="btnSalvar" type="button" class="btn" >Salvar</button>
        </div>
    </div>

    <!-- Modal de Confirmação de Cancelamento -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelModalLabel">Cancelar cadastro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <i class="bi bi-exclamation-circle" style="color: rgb(252, 210, 25); margin-right: 10px;"></i>
                    Tem certeza de que deseja cancelar o cadastro?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn2" data-bs-dismiss="modal">Não</button>
                    <button type="button" class="btn btn-danger" onclick="window.location.href='../hangar/hangarPage.html';">Sim, cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-labelledby="modalConfirmacaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Hangar atualizado com sucesso!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <i class="bi bi-check-circle" style="color: green; font-size: rem;"></i>
                    O hangar foi atualizado com sucesso.
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
      new window.VLibras.Widget('https://vlibras.gov.br/app');
    </script>

<script>
        // Função para buscar os dados do hangar por ID
        document.addEventListener("DOMContentLoaded", function () {
            const hangarId = new URLSearchParams(window.location.search).get("id");

            if (hangarId) {
                fetchHangars(hangarId);  // Passando o hangarId como argumento para fetchHangars
                buscarHangarPorId(hangarId);
            } else {
                console.error('ID do hangar não encontrado na URL');
            }
        });
// Armazena as aeronaves vinculadas ao hangar
let aeronavesVinculadas = [];

// Armazena todas as aeronaves disponíveis para seleção
let todasAeronaves = [];

// Função para inicializar a interface com os dados
async function inicializarInterface(hangar) {
    aeronavesVinculadas = hangar.aeronaves || [];
    atualizarTagsAeronaves();

    // Buscar todas as aeronaves disponíveis
    todasAeronaves = await buscarTodasAeronaves();
    popularDropdownAeronaves();
}

// Atualizar as tags de aeronaves vinculadas
function atualizarTagsAeronaves() {
    const container = document.getElementById("aeronaves-container");
    container.innerHTML = "";

    aeronavesVinculadas.forEach((aeronave) => {
        const tag = document.createElement("div");
        tag.className = "badge bg-secondary p-2 d-flex align-items-center gap-2";
        tag.style.cursor = "pointer";

        const text = document.createElement("span");
        text.textContent = `${aeronave.modelo} (${aeronave.matricula})`;

        const removeBtn = document.createElement("i");
        removeBtn.className = "bi bi-x-circle";
        removeBtn.style.cursor = "pointer";
        removeBtn.onclick = () => removerAeronave(aeronave.id);

        tag.appendChild(text);
        tag.appendChild(removeBtn);
        container.appendChild(tag);
    });
}

// Popular o dropdown com aeronaves disponíveis
function popularDropdownAeronaves() {
    const select = document.getElementById("aeronaves-select");

    if (!select) {
        console.error("Elemento de seleção não encontrado.");
        return;
    }

    select.innerHTML = "";

    // Filtrar aeronaves que ainda não estão vinculadas ao hangar
    const disponiveis = todasAeronaves.filter(
        (aeronave) => !aeronavesVinculadas.some((a) => a.id === aeronave.id)
    );

    if (disponiveis.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "Nenhuma aeronave disponível";
        option.disabled = true;
        option.selected = true;
        select.appendChild(option);
        return;
    }

    // Preencher o select com aeronaves disponíveis
    disponiveis.forEach((aeronave) => {
        const option = document.createElement("option");
        option.value = aeronave.id;
        option.textContent = `${aeronave.modelo} (${aeronave.matricula})`;
        select.appendChild(option);
    });
}


// Adicionar aeronave ao hangar
function adicionarAeronave() {
    const select = document.getElementById("aeronaves-select");
    const selectedId = parseInt(select.value);

    if (selectedId) {
        const aeronaveSelecionada = todasAeronaves.find((aeronave) => aeronave.id === selectedId);
        if (aeronaveSelecionada) {
            aeronavesVinculadas.push(aeronaveSelecionada);
            atualizarTagsAeronaves();
            popularDropdownAeronaves();
        }
    }
}

// Remover aeronave do hangar
function removerAeronave(aeronaveId) {
    aeronavesVinculadas = aeronavesVinculadas.filter((aeronave) => aeronave.id !== aeronaveId);
    atualizarTagsAeronaves();
    popularDropdownAeronaves();
}

// Buscar todas as aeronaves disponíveis (simulação de API)
async function buscarTodasAeronaves() {
    const user = localStorage.getItem("user");
    const password = localStorage.getItem("password");

    if (user && password) {
        const basicAuth = btoa(`${user}:${password}`);

        try {
            const response = await fetch("https://a3-airport-midm.onrender.com/airplanes/", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Basic ${basicAuth}`,
                },
            });

            if (!response.ok) {
                throw new Error(`Erro ao buscar aeronaves: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error("Erro ao buscar aeronaves:", error);
            return [];
        }
    }
    return [];
}

// Chamada inicial
document.addEventListener("DOMContentLoaded", async function () {
    const hangarId = new URLSearchParams(window.location.search).get("id");

    if (hangarId) {
        const user = localStorage.getItem("user");
        const password = localStorage.getItem("password");

        if (user && password) {
            const basicAuth = btoa(`${user}:${password}`);

            try {
                const response = await fetch(`https://a3-airport-midm.onrender.com/hangars/${hangarId}/`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Basic ${basicAuth}`,
                    },
                });

                if (!response.ok) {
                    throw new Error(`Erro ao carregar hangar: ${response.status}`);
                }

                const hangar = await response.json();
                await inicializarInterface(hangar);
            } catch (error) {
                console.error("Erro ao carregar hangar:", error);
            }
        }
    }
});
        async function fetchHangars(hangarId) {
    const user = localStorage.getItem("user");
    const password = localStorage.getItem("password");

    if (user && password) {
        const basicAuth = btoa(`${user}:${password}`);

        try {
            console.log('Iniciando o carregamento dos hangares...');
            const overlay = document.getElementById("overlay");
            if (overlay) overlay.style.display = "flex";  // Mostra o overlay enquanto carrega os dados

            // Buscar os hangares (usando o hangarId)
            const response = await fetch(`https://a3-airport-midm.onrender.com/hangars/${hangarId}/`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Basic ${basicAuth}`,
                },
            });

            if (!response.ok) {
                throw new Error(`Erro ao carregar hangar: ${response.status} - ${response.statusText}`);
            }

            const hangar = await response.json();

            // Preencher o select com os tipos de hangar
            const hangarSelect = document.getElementById("tipo");
            hangarSelect.innerHTML = '';  

            const tipos = [
                { value: 'P', label: 'Pequeno' },
                { value: 'M', label: 'Médio' },
                { value: 'G', label: 'Grande' }
            ];

            // Adicionar os tipos de hangar ao select
            tipos.forEach(tipo => {
                const option = document.createElement("option");
                option.value = tipo.value;
                option.textContent = tipo.label;
                hangarSelect.appendChild(option);
            });

            // Selecionar o tipo de hangar atual
            hangarSelect.value = hangar.tipo || '';

            // Preencher o formulário com os dados do hangar
            document.getElementById("codigo").value = hangar.codigo || '';
            document.getElementById("nome").value = hangar.nome || '';
            document.getElementById("capacidade_maxima").value = hangar.capacidade_maxima || '';
            document.getElementById("localizacao").value = hangar.localizacao || '';

            // Preencher as aeronaves (em caso de múltiplas aeronaves associadas)
            const aeronavesSelect = document.getElementById("aeronaves");
            hangar.aeronaves.forEach(aeronave => {
                const option = document.createElement("option");
                option.value = aeronave.id;
                option.textContent = aeronave.nome;
                aeronavesSelect.appendChild(option);

                // Adicionar cada aeronave vinculada como tag removível
                addAeronaveTag(aeronave);  // Função que adiciona as aeronaves como tags
            });

            if (overlay) overlay.style.display = "none";  // Esconde o overlay após o carregamento
        } catch (error) {
            console.error('Erro ao buscar hangares:', error);
        }
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const salvarBtn = document.getElementById("btnSalvar");

    if (!salvarBtn) {
        console.error("Botão de salvar não encontrado.");
        return;
    }

    salvarBtn.addEventListener("click", async function salvarHangar() {
        console.log("Botão de salvar clicado!");

        const hangarId = new URLSearchParams(window.location.search).get("id");

        if (!hangarId) {
            console.error("ID do hangar não encontrado.");
            return;
        }

        const user = localStorage.getItem("user");
        const password = localStorage.getItem("password");

        if (!user || !password) {
            console.error("Credenciais não encontradas.");
            return;
        }

        const basicAuth = btoa(`${user}:${password}`);

        // Obter os campos do formulário
        const codigo = document.getElementById("codigo")?.value || "";
        const nome = document.getElementById("nome")?.value || "";
        const tipo = document.getElementById("tipo")?.value || "";
        const capacidadeMaxima = document.getElementById("capacidade-maxima")?.value || 0;
        const localizacao = document.getElementById("localizacao")?.value || "";

        // Verificar se o select de aeronaves está correto
        const selectAeronaves = document.getElementById("aeronaves-select");
        if (!selectAeronaves) {
            console.error("Elemento select de aeronaves não encontrado.");
            return;
        }

        // Capturar as opções selecionadas
        const aeronavesSelecionadas = Array.from(selectAeronaves.selectedOptions).map((option) => ({
            id: parseInt(option.value, 10),
            matricula: option.dataset.matricula || "",
            numero_Voo: option.dataset.numeroVoo || "",
            modelo: option.dataset.modelo || "",
            procedencia: option.dataset.procedencia || "",
            destino: option.dataset.destino || "",
            numero_passageiros: option.dataset.numeroPassageiros ? parseInt(option.dataset.numeroPassageiros, 10) : null,
            hangar: hangarId,
        }));

        console.log("Dados coletados: ", {
            codigo,
            nome,
            tipo,
            capacidadeMaxima,
            localizacao,
            aeronavesSelecionadas
        });

        // Construir o objeto para enviar
        const hangar = {
            id: parseInt(hangarId, 10),
            codigo,
            nome,
            tipo,
            capacidade_maxima: capacidadeMaxima,
            localizacao,
            aeronaves: aeronavesSelecionadas,
        };

        try {
            const response = await fetch(`https://a3-airport-midm.onrender.com/hangars/${hangarId}/`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Basic ${basicAuth}`,
                },
                body: JSON.stringify(hangar),
            });

            console.log("Resposta da API:", response); // Adicionando log para capturar a resposta da API

            if (!response.ok) {
                throw new Error(`Erro ao salvar hangar: ${response.status}`);
            }

            
            if (response.ok) {
                    showMessageRegister("Hangar atualizado com sucesso!", "success");
                    setTimeout(() => {
                        window.location.href = '../hangar/hangarPage.html';
                    }, 3000);
                } else {
                    const error = await response.json();
                    showMessageRegister("Erro ao atualizar hangar: " + error.detail, "error");
                }
        } catch (error) {
            console.error("Erro ao salvar o hangar:", error);
            alert("Erro ao salvar o hangar. Consulte o console para mais detalhes.");
        }
    });
});
</script>
<script>
    function showMessageRegister(message, type) {
    const messageDiv = document.createElement("div");
    messageDiv.textContent = message;
    
    if (type === "success") {
        messageDiv.style.backgroundColor = "green";
        messageDiv.style.color = "white";
    } else if (type === "error") {
        messageDiv.style.backgroundColor = "red";
        messageDiv.style.color = "white";
    }
    
    messageDiv.style.position = "fixed";
    messageDiv.style.top = "20px";
    messageDiv.style.left = "50%";
    messageDiv.style.transform = "translateX(-50%)";
    messageDiv.style.padding = "10px 20px";
    messageDiv.style.borderRadius = "5px";
    messageDiv.style.zIndex = "1000";

    document.body.appendChild(messageDiv);

    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}
</script>
</body>
</html>
